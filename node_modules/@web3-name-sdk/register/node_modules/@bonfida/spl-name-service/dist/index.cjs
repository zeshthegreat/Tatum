"use strict";var e=require("@solana/web3.js"),t=require("buffer"),r=require("@solana/spl-token"),i=require("bn.js"),s=require("borsh"),n=require("@ethersproject/sha2"),o=require("@pythnetwork/client"),a=require("bech32-buffer"),c=require("tweetnacl"),u=require("bs58"),p=require("ipaddr.js"),d=require("punycode");function l(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var i=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,i.get?i:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var f,y=l(c);exports.ErrorType=void 0,(f=exports.ErrorType||(exports.ErrorType={})).SymbolNotFound="SymbolNotFound",f.InvalidSubdomain="InvalidSubdomain",f.FavouriteDomainNotFound="FavouriteDomainNotFound",f.MissingParentOwner="MissingParentOwner",f.U32Overflow="U32Overflow",f.InvalidBufferLength="InvalidBufferLength",f.U64Overflow="U64Overflow",f.NoRecordData="NoRecordData",f.InvalidRecordData="InvalidRecordData",f.UnsupportedRecord="UnsupportedRecord",f.InvalidEvmAddress="InvalidEvmAddress",f.InvalidInjectiveAddress="InvalidInjectiveAddress",f.InvalidARecord="InvalidARecord",f.InvalidAAAARecord="InvalidAAAARecord",f.InvalidRecordInput="InvalidRecordInput",f.InvalidSignature="InvalidSignature",f.AccountDoesNotExist="AccountDoesNotExist",f.MultipleRegistries="MultipleRegistries",f.InvalidReverseTwitter="InvalidReverseTwitter",f.NoAccountData="NoAccountData",f.InvalidInput="InvalidInput",f.InvalidDomain="InvalidDomain",f.InvalidCustomBg="InvalidCustomBackground";class g extends Error{constructor(e,t){super(t),this.name="SNSError",this.type=e,Error.captureStackTrace&&Error.captureStackTrace(this,g)}}class w extends i{toBuffer(){const e=super.toArray().reverse(),r=t.Buffer.from(e);if(4===r.length)return r;if(r.length>4)throw new g(exports.ErrorType.U32Overflow);const i=t.Buffer.alloc(4);return r.copy(i),i}static fromBuffer(e){if(4!==e.length)throw new g(exports.ErrorType.InvalidBufferLength,`Invalid buffer length: ${e.length}`);return new i([...e].reverse().map((e=>`00${e.toString(16)}`.slice(-2))).join(""),16)}}class b extends i{toBuffer(){const e=super.toArray().reverse(),r=t.Buffer.from(e);if(8===r.length)return r;if(r.length>8)throw new g(exports.ErrorType.U64Overflow);const i=t.Buffer.alloc(8);return r.copy(i),i}static fromBuffer(e){if(8!==e.length)throw new g(exports.ErrorType.U64Overflow,`Invalid buffer length: ${e.length}`);return new i([...e].reverse().map((e=>`00${e.toString(16)}`.slice(-2))).join(""),16)}}function m(r,i,s,n,o,a,c,u,p,d,l){const f=[t.Buffer.from(Int8Array.from([0])),new w(a.length).toBuffer(),a,c.toBuffer(),u.toBuffer()],y=t.Buffer.concat(f),g=[{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1}];return p?g.push({pubkey:p,isSigner:!0,isWritable:!1}):g.push({pubkey:new e.PublicKey(t.Buffer.alloc(32)),isSigner:!1,isWritable:!1}),d?g.push({pubkey:d,isSigner:!1,isWritable:!1}):g.push({pubkey:new e.PublicKey(t.Buffer.alloc(32)),isSigner:!1,isWritable:!1}),l&&g.push({pubkey:l,isSigner:!0,isWritable:!1}),new e.TransactionInstruction({keys:g,programId:r,data:y})}function h(r,i,s,n,o){const a=[t.Buffer.from(Int8Array.from([1])),s.toBuffer(),new w(n.length).toBuffer(),n],c=t.Buffer.concat(a),u=[{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1}];return new e.TransactionInstruction({keys:u,programId:r,data:c})}function x(r,i,s,n,o,a,c){const u=[t.Buffer.from(Int8Array.from([2])),s.toBuffer()],p=t.Buffer.concat(u),d=[{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:c||n,isSigner:!0,isWritable:!1}];return o&&d.push({pubkey:o,isSigner:!0,isWritable:!1}),c&&a&&(o||d.push({pubkey:e.PublicKey.default,isSigner:!1,isWritable:!1}),d.push({pubkey:a,isSigner:!1,isWritable:!1})),new e.TransactionInstruction({keys:d,programId:r,data:p})}function S(r,i,s,n){const o=[t.Buffer.from(Int8Array.from([3]))],a=t.Buffer.concat(o),c=[{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0}];return new e.TransactionInstruction({keys:c,programId:r,data:a})}class R{constructor(e){this.tag=9,this.name=e.name,this.space=e.space}serialize(){return s.serialize(R.schema,this)}getInstruction(i,s,n,o,a,c,u,p,d,l,f){const y=t.Buffer.from(this.serialize()),g=[{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:e.SystemProgram.programId,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!0,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:r.TOKEN_PROGRAM_ID,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1}];return new e.TransactionInstruction({keys:g,programId:i,data:y})}}R.schema=new Map([[R,{kind:"struct",fields:[["tag","u8"],["name","string"],["space","u32"]]}]]);class v{constructor(e){this.tag=12,this.name=e.name}serialize(){return s.serialize(v.schema,this)}getInstruction(r,i,s,n,o,a,c,u,p,d){const l=t.Buffer.from(this.serialize());let f=[];return f.push({pubkey:i,isSigner:!1,isWritable:!1}),f.push({pubkey:s,isSigner:!1,isWritable:!1}),f.push({pubkey:n,isSigner:!1,isWritable:!0}),f.push({pubkey:o,isSigner:!1,isWritable:!1}),f.push({pubkey:a,isSigner:!1,isWritable:!1}),f.push({pubkey:c,isSigner:!0,isWritable:!0}),f.push({pubkey:u,isSigner:!1,isWritable:!1}),p&&f.push({pubkey:p,isSigner:!1,isWritable:!0}),d&&f.push({pubkey:d,isSigner:!0,isWritable:!0}),new e.TransactionInstruction({keys:f,programId:r,data:l})}}v.schema=new Map([[v,{kind:"struct",fields:[["tag","u8"],["name","string"]]}]]);class A{constructor(e){this.tag=13,this.name=e.name,this.space=e.space,this.referrerIdxOpt=e.referrerIdxOpt}serialize(){return s.serialize(A.schema,this)}getInstruction(r,i,s,n,o,a,c,u,p,d,l,f,y,g,w,b,m){const h=t.Buffer.from(this.serialize());let x=[];return x.push({pubkey:i,isSigner:!1,isWritable:!1}),x.push({pubkey:s,isSigner:!1,isWritable:!1}),x.push({pubkey:n,isSigner:!1,isWritable:!0}),x.push({pubkey:o,isSigner:!1,isWritable:!0}),x.push({pubkey:a,isSigner:!1,isWritable:!1}),x.push({pubkey:c,isSigner:!1,isWritable:!1}),x.push({pubkey:u,isSigner:!0,isWritable:!0}),x.push({pubkey:p,isSigner:!1,isWritable:!0}),x.push({pubkey:d,isSigner:!1,isWritable:!1}),x.push({pubkey:l,isSigner:!1,isWritable:!1}),x.push({pubkey:f,isSigner:!1,isWritable:!1}),x.push({pubkey:y,isSigner:!1,isWritable:!0}),x.push({pubkey:g,isSigner:!1,isWritable:!1}),x.push({pubkey:w,isSigner:!1,isWritable:!1}),x.push({pubkey:b,isSigner:!1,isWritable:!1}),m&&x.push({pubkey:m,isSigner:!1,isWritable:!0}),new e.TransactionInstruction({keys:x,programId:r,data:h})}}A.schema=new Map([[A,{kind:"struct",fields:[["tag","u8"],["name","string"],["space","u32"],["referrerIdxOpt",{kind:"option",type:"u16"}]]}]]);class k{constructor(e){this.tag=17,this.name=e.name,this.space=e.space}serialize(){return s.serialize(k.schema,this)}getInstruction(r,i,s,n,o,a,c,u,p,d,l,f,y,g,w,b,m){const h=t.Buffer.from(this.serialize());let x=[];return x.push({pubkey:i,isSigner:!1,isWritable:!1}),x.push({pubkey:s,isSigner:!1,isWritable:!1}),x.push({pubkey:n,isSigner:!1,isWritable:!0}),x.push({pubkey:o,isSigner:!1,isWritable:!0}),x.push({pubkey:a,isSigner:!1,isWritable:!1}),x.push({pubkey:c,isSigner:!1,isWritable:!1}),x.push({pubkey:u,isSigner:!0,isWritable:!0}),x.push({pubkey:p,isSigner:!1,isWritable:!0}),x.push({pubkey:d,isSigner:!1,isWritable:!0}),x.push({pubkey:l,isSigner:!1,isWritable:!0}),x.push({pubkey:f,isSigner:!1,isWritable:!0}),x.push({pubkey:y,isSigner:!1,isWritable:!0}),x.push({pubkey:g,isSigner:!1,isWritable:!1}),x.push({pubkey:w,isSigner:!1,isWritable:!1}),x.push({pubkey:b,isSigner:!1,isWritable:!1}),x.push({pubkey:m,isSigner:!1,isWritable:!1}),new e.TransactionInstruction({keys:x,programId:r,data:h})}}k.schema=new Map([[k,{kind:"struct",fields:[["tag","u8"],["name","string"],["space","u32"]]}]]);class E{constructor(){this.tag=16}serialize(){return s.serialize(E.schema,this)}getInstruction(r,i,s,n,o,a,c,u,p,d){const l=t.Buffer.from(this.serialize());let f=[];return f.push({pubkey:i,isSigner:!1,isWritable:!1}),f.push({pubkey:s,isSigner:!1,isWritable:!1}),f.push({pubkey:n,isSigner:!1,isWritable:!0}),f.push({pubkey:o,isSigner:!1,isWritable:!0}),f.push({pubkey:a,isSigner:!1,isWritable:!0}),f.push({pubkey:c,isSigner:!1,isWritable:!0}),f.push({pubkey:u,isSigner:!1,isWritable:!1}),f.push({pubkey:p,isSigner:!0,isWritable:!1}),f.push({pubkey:d,isSigner:!1,isWritable:!0}),new e.TransactionInstruction({keys:f,programId:r,data:l})}}E.schema=new Map([[E,{kind:"struct",fields:[["tag","u8"]]}]]);const B=new e.PublicKey("nftD3vbNkNqfj2Sd3HZwbpw4BxxKWr4AjGb9X38JeZk"),I=t.Buffer.from("tokenized_name");var P;!function(e){e[e.Uninitialized=0]="Uninitialized",e[e.CentralState=1]="CentralState",e[e.ActiveRecord=2]="ActiveRecord",e[e.InactiveRecord=3]="InactiveRecord"}(P||(P={}));class T{constructor(t){this.tag=t.tag,this.nonce=t.nonce,this.nameAccount=new e.PublicKey(t.nameAccount),this.owner=new e.PublicKey(t.owner),this.nftMint=new e.PublicKey(t.nftMint)}static deserialize(e){return s.deserialize(this.schema,T,e)}static async retrieve(e,t){const r=await e.getAccountInfo(t);if(!r||!r.data)throw new Error("NFT record not found");return this.deserialize(r.data)}static async findKey(r,i){return await e.PublicKey.findProgramAddress([t.Buffer.from("nft_record"),r.toBuffer()],i)}}T.schema=new Map([[T,{kind:"struct",fields:[["tag","u8"],["nonce","u8"],["nameAccount",[32]],["owner",[32]],["nftMint",[32]]]}]]);const W=new e.PublicKey("namesLPneVptA9Z5rqUDD9tMTWEJwofgaYwp8cawRkX"),D="SPL Name Service",K=new e.PublicKey("58PwtjSDuFHuUkYjH9BYnnQKHfwo9reZhC2zMJv9JPkx"),N=new e.PublicKey("jCebN34bUfdeUYJT13J1yG16XWQpt5PDx6Mse9GUqhR"),C=new e.PublicKey("ETp9eKXVv1dWwHSpsXRUuXHmw24PwRkttCGVgpZEY9zF"),O=new e.PublicKey("AUoZ3YAhV3b2rZeEH93UMZHXUZcTramBvb4d9YEVySkc"),_=new e.PublicKey("33m47vH6Eav6jr5Ry86XjhRft2jRBLDnDgPSHoquXi2Z"),L=new e.PublicKey("FvPH7PrVrLGKPfqaf3xJodFTjZriqrAXXLTVWEorTFBi"),M=new e.PublicKey("4YcexoW3r78zz16J2aqmukBLRwGq6rAvWzJpkYAXqebv"),H=new e.PublicKey("DmSyHDSM9eSLyvoLsPvDr5fRRFZ7Bfr3h3ULvWpgQaq7"),z=new e.PublicKey("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),F=[new e.PublicKey("3ogYncmMM5CmytsGCqKHydmXmKUZ6sGWvizkzqwT7zb1"),new e.PublicKey("DM1jJCkZZEwY5tmWbgvKRxsDFzXCdbfrYCCH1CtwguEs"),new e.PublicKey("ADCp4QXFajHrhy4f43pD6GJFtQLkdBY2mjS9DfCk7tNW"),new e.PublicKey("2XTgjw8yi1E3Etgj4CUyRD7Zk49gynH2U9gA5N2MY4NP"),new e.PublicKey("5oDWj8vr3vbcq9JZTtwXqrkCMZggMsDzNietvbr1BNfe"),new e.PublicKey("8kJqxAbqbPLGLMgB6FhLcnw2SiUEavx2aEGM3WQGhtJF"),new e.PublicKey("HemvJzwxvVpWBjPETpaseAH395WAxb2G73MeUfjVkK1u")],U=new Map([["EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v","USDC"],["Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB","USDT"],["So11111111111111111111111111111111111111112","SOL"],["EchesyfXePKdLtoiZSL8pBe8Myagyy8ZRqsACNCFGnvp","FIDA"],["FeGn77dhg1KXRRFeSwwMiykZnZPw5JXW6naf2aQgZDQf","ETH"],["7i5KKsX2weiTkry7jA4ZwSuXGhs5eJBEjY8vVxR4pfRx","GMT"],["AFbX8oGjGpmVFywbVouvhQSRmiW2aR1mohfahi4Y2AdB","GST"],["mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So","MSOL"],["DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263","BONK"],["EPeUFDgHRxs9xxEPVaL6kfGQvCon7jmAWKVUHuux1Tpz","BAT"]]),j=new e.PublicKey("AHtgzX45WTKfkPG53L6WYhGEXwQkN1BVknET3sVsLL8J"),G=new e.PublicKey("GcWEQ9K78FV7LEHteFVciYApERk5YvQuFDQPk1yYJVXi"),q=new e.PublicKey("BPeXUQDqGbzxeK1LJby6ugvCBuo7kRSEUkjD726mUVsz"),V=new e.PublicKey("72aLKvXeV4aansAQtxKymeXDevT5ed6sCuz9iN62ugPT"),X=new e.PublicKey("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),Y=e=>{const r=D+e,i=n.sha256(t.Buffer.from(r,"utf8")).slice(2);return t.Buffer.from(i,"hex")},Z=(r,i,s)=>{const n=[r];i?n.push(i.toBuffer()):n.push(t.Buffer.alloc(32)),s?n.push(s.toBuffer()):n.push(t.Buffer.alloc(32));const[o]=e.PublicKey.findProgramAddressSync(n,W);return o};async function J(e,t){const r=Y(t.toBase58()),s=Z(r,_),{registry:n}=await ae.retrieve(e,s);if(!n.data)throw new g(exports.ErrorType.NoAccountData);const o=new i(n.data.slice(0,4),"le").toNumber();return n.data.slice(4,4+o).toString()}async function Q(e,t){let r=[];for(let e of t){const t=Y(e.toBase58()),i=Z(t,_);r.push(i)}return(await ae.retrieveBatch(e,r)).map((e=>{if(void 0===e||void 0===e.data)return;let t=new i(e.data.slice(0,4),"le").toNumber();return e.data.slice(4,4+t).toString()}))}const $=(e,t=K)=>{let r=Y(e);return{pubkey:Z(r,void 0,t),hashed:r}},ee=(e,r=!1)=>{e.endsWith(".sol")&&(e=e.slice(0,-4));const i=e.split(".");if(2===i.length){const e=t.Buffer.from([r?1:0]).toString().concat(i[0]),{pubkey:s}=$(i[1]);return{...$(e,s),isSub:!0,parent:s}}if(3===i.length&&r){const{pubkey:e}=$(i[2]),{pubkey:r}=$("\0".concat(i[1]),e),s=t.Buffer.from([1]).toString();return{...$(s.concat(i[0]),r),isSub:!0,parent:e,isSubRecord:!0}}if(i.length>=3)throw new g(exports.ErrorType.InvalidInput);return{...$(e,K),isSub:!1,parent:void 0}};async function te(e,t){const r=[{memcmp:{offset:32,bytes:t.toBase58()}},{memcmp:{offset:0,bytes:K.toBase58()}}];return(await e.getProgramAccounts(W,{filters:r})).map((e=>e.pubkey))}const re=(e,t)=>{const{pubkey:r,parent:i}=ee(e),s=Y(r.toBase58());return Z(s,_,t?i:void 0)},ie=(e,t)=>{if(!e)throw new g(t)},se=async(t,i)=>{try{const[s]=await e.PublicKey.findProgramAddress([I,i.toBuffer()],B);if("0"===(await r.getMint(t,s)).supply.toString())return;const n=[{memcmp:{offset:0,bytes:s.toBase58()}},{memcmp:{offset:64,bytes:"2"}},{dataSize:165}],o=await t.getProgramAccounts(r.TOKEN_PROGRAM_ID,{filters:n});if(1!=o.length)return;return new e.PublicKey(o[0].account.data.slice(32,64))}catch{return}},ne=e=>[{memcmp:{offset:32,bytes:e}},{memcmp:{offset:64,bytes:"2"}}],oe=async(e,t)=>{const r=await(async(e,t)=>{const r=[{memcmp:{offset:0,bytes:"3"}},{memcmp:{offset:66,bytes:t.toBase58()}}];return await e.getProgramAccounts(B,{filters:r})})(e,t.mint);if(1===r.length)return T.deserialize(r[0].account.data)};class ae{constructor(t){this.parentName=new e.PublicKey(t.parentName),this.owner=new e.PublicKey(t.owner),this.class=new e.PublicKey(t.class)}static async retrieve(e,t){var r;const i=await e.getAccountInfo(t);if(!i)throw new g(exports.ErrorType.AccountDoesNotExist);let n=s.deserializeUnchecked(this.schema,ae,i.data);n.data=null===(r=i.data)||void 0===r?void 0:r.slice(this.HEADER_LEN);return{registry:n,nftOwner:await se(e,t)}}static async _retrieveBatch(e,t){const r=await e.getMultipleAccountsInfo(t),i=e=>{if(!e)return;const t=s.deserializeUnchecked(this.schema,ae,e);return t.data=null==e?void 0:e.slice(this.HEADER_LEN),t};return r.map((e=>i(null==e?void 0:e.data)))}static async retrieveBatch(e,t){let r=[];const i=[...t];for(;i.length>0;)r.push(...await this._retrieveBatch(e,i.splice(0,100)));return r}}async function ce(e,t){if(!await e.getAccountInfo(t))throw new g(exports.ErrorType.AccountDoesNotExist);return ae.retrieve(e,t)}async function ue(e){const r=D+e,i=n.sha256(t.Buffer.from(r,"utf8")).slice(2);return t.Buffer.from(i,"hex")}async function pe(r,i,s){const n=[r];i?n.push(i.toBuffer()):n.push(t.Buffer.alloc(32)),s?n.push(s.toBuffer()):n.push(t.Buffer.alloc(32));const[o]=await e.PublicKey.findProgramAddress(n,W);return o}ae.HEADER_LEN=96,ae.schema=new Map([[ae,{kind:"struct",fields:[["parentName",[32]],["owner",[32]],["class",[32]]]}]]);const de=async(e,t=K)=>{let r=await ue(e);return{pubkey:await pe(r,void 0,t),hashed:r}},le=async(e,r=!1)=>{e.endsWith(".sol")&&(e=e.slice(0,-4));const i=e.split(".");if(2===i.length){const e=t.Buffer.from([r?1:0]).toString().concat(i[0]),{pubkey:s}=await de(i[1]);return{...await de(e,s),isSub:!0,parent:s}}if(3===i.length&&r){const{pubkey:e}=await de(i[2]),{pubkey:r}=await de("\0".concat(i[1]),e),s=t.Buffer.from([1]).toString();return{...await de(s.concat(i[0]),r),isSub:!0,parent:e,isSubRecord:!0}}if(i.length>=3)throw new g(exports.ErrorType.InvalidInput);return{...await de(e,K),isSub:!1,parent:void 0}};var fe;exports.Record=void 0,(fe=exports.Record||(exports.Record={})).IPFS="IPFS",fe.ARWV="ARWV",fe.SOL="SOL",fe.ETH="ETH",fe.BTC="BTC",fe.LTC="LTC",fe.DOGE="DOGE",fe.Email="email",fe.Url="url",fe.Discord="discord",fe.Github="github",fe.Reddit="reddit",fe.Twitter="twitter",fe.Telegram="telegram",fe.Pic="pic",fe.SHDW="SHDW",fe.POINT="POINT",fe.BSC="BSC",fe.Injective="INJ",fe.Backpack="backpack",fe.A="A",fe.AAAA="AAAA",fe.CNAME="CNAME",fe.TXT="TXT",fe.Background="background";const ye=new Map([[exports.Record.SOL,96],[exports.Record.ETH,20],[exports.Record.BSC,20],[exports.Record.Injective,20],[exports.Record.A,4],[exports.Record.AAAA,16],[exports.Record.Background,32]]),ge=(e,t,r)=>y.sign.detached.verify(e,t,r.toBytes()),we=(e,t)=>{const{pubkey:r}=ee(t+"."+e,!0);return r};async function be(e,t,r,i){const s=we(t,r);let{registry:n}=await ae.retrieve(e,s);if(!n.data)throw new g(exports.ErrorType.NoRecordData);if(i)return he(n,r,s);const o=ye.get(r);return n.data=n.data.slice(0,o),n}const me=async(e,t)=>await be(e,t,exports.Record.SOL),he=(r,i,s)=>{const n=null==r?void 0:r.data;if(!n)return;if(0===n.compare(t.Buffer.alloc(n.length)))return;const o=ye.get(i),c=(e=>{const t=Array.from(e);return t.length-1-t.reverse().findIndex((e=>0!==e))+1})(n);if(!o)return n.slice(0,c).toString("utf-8");if(i===exports.Record.SOL){const e=new TextEncoder,i=t.Buffer.concat([n.slice(0,32),s.toBuffer()]),o=e.encode(i.toString("hex"));if(ge(o,n.slice(32,96),r.owner))return u.encode(n.slice(0,32))}if(o&&c!==o){const e=n.slice(0,c).toString("utf-8");if(i===exports.Record.Injective){const t=a.decode(e);if("inj"===t.prefix&&20===t.data.length)return e}else if(i===exports.Record.BSC||i===exports.Record.ETH){const r=e.slice(0,2),i=e.slice(2);if("0x"===r&&20===t.Buffer.from(i,"hex").length)return e}else if((i===exports.Record.A||i===exports.Record.AAAA)&&p.isValid(e))return e;throw new g(exports.ErrorType.InvalidRecordData)}if(i===exports.Record.ETH||i===exports.Record.BSC)return"0x"+n.slice(0,o).toString("hex");if(i===exports.Record.Injective)return a.encode("inj",n.slice(0,o),"bech32");if(i===exports.Record.A||i===exports.Record.AAAA)return p.fromByteArray([...n.slice(0,o)]).toString();if(i===exports.Record.Background)return new e.PublicKey(n.slice(0,o)).toString();throw new g(exports.ErrorType.InvalidRecordData)},xe=(r,i)=>{if(!ye.get(i))return i!==exports.Record.CNAME&&i!==exports.Record.TXT||(r=d.encode(r)),t.Buffer.from(r,"utf-8");if(i===exports.Record.SOL)throw new g(exports.ErrorType.UnsupportedRecord,"Use `serializeSolRecord` for SOL record");if(i===exports.Record.ETH||i===exports.Record.BSC)return ie("0x"===r.slice(0,2),exports.ErrorType.InvalidEvmAddress),t.Buffer.from(r.slice(2),"hex");if(i===exports.Record.Injective){const e=a.decode(r);return ie("inj"===e.prefix,exports.ErrorType.InvalidInjectiveAddress),ie(20===e.data.length,exports.ErrorType.InvalidInjectiveAddress),t.Buffer.from(e.data)}if(i===exports.Record.A){const e=p.parse(r).toByteArray();return ie(4===e.length,exports.ErrorType.InvalidARecord),t.Buffer.from(e)}if(i===exports.Record.AAAA){const e=p.parse(r).toByteArray();return ie(16===e.length,exports.ErrorType.InvalidAAAARecord),t.Buffer.from(e)}if(i===exports.Record.Background)return new e.PublicKey(r).toBuffer();throw new g(exports.ErrorType.InvalidRecordInput)},Se=(e,r,i,s)=>{const n=t.Buffer.concat([e.toBuffer(),r.toBuffer()]),o=(new TextEncoder).encode(n.toString("hex")),a=ge(o,s,i);return ie(a,exports.ErrorType.InvalidSignature),t.Buffer.concat([e.toBuffer(),s])};async function Re(t,r,i,s,n,o,a,c){const u=await ue(r),p=await pe(u,a,c),d=o||await t.getMinimumBalanceForRentExemption(i);let l;if(c){const{registry:e}=await ce(t,c);l=e.owner}return m(W,e.SystemProgram.programId,p,n,s,u,new b(d),new w(i),a,c,l)}async function ve(e,t,r,i,s){const n=await ue(t),o=await pe(n,i,s);let a;a=i||(await ae.retrieve(e,o)).registry.owner;return S(W,o,r,a)}const Ae=async(t,r,i,s,n)=>{let[o]=await e.PublicKey.findProgramAddress([N.toBuffer()],N),a=await ue(t.toBase58()),c=await pe(a,o,s);return[[],[new v({name:r}).getInstruction(N,W,K,c,e.SystemProgram.programId,o,i,e.SYSVAR_RENT_PUBKEY,s,n)]]},ke=async(t,r,i,s,n,o)=>{ie(i!==exports.Record.SOL,exports.ErrorType.UnsupportedRecord);const{pubkey:a,hashed:c,parent:u}=ee(`${i}.${r}`,!0),p=xe(s,i).length,d=await t.getMinimumBalanceForRentExemption(p+ae.HEADER_LEN);return m(W,e.SystemProgram.programId,a,n,o,c,new b(d),new w(p),void 0,u,n)},Ee=async(t,r,i,s,n,o)=>{const{pubkey:a,hashed:c,parent:u}=ee(`${exports.Record.SOL}.${r}`,!0),p=Se(i,a,s,n).length,d=await t.getMinimumBalanceForRentExemption(p+ae.HEADER_LEN);return[m(W,e.SystemProgram.programId,a,s,o,c,new b(d),new w(p),void 0,u,s)]};class Be{constructor(e){this.twitterRegistryKey=e.twitterRegistryKey,this.twitterHandle=e.twitterHandle}static async retrieve(e,t){let r=await e.getAccountInfo(t,"processed");if(!r)throw new g(exports.ErrorType.InvalidReverseTwitter);return s.deserializeUnchecked(this.schema,Be,r.data.slice(ae.HEADER_LEN))}}async function Ie(r,i,n,o,a){const c=await ue(o.toString()),u=await pe(c,L,M);let p=s.serialize(Be.schema,new Be({twitterRegistryKey:n.toBytes(),twitterHandle:i}));return[m(W,e.SystemProgram.programId,u,o,a,c,new b(await r.getMinimumBalanceForRentExemption(p.length+ae.HEADER_LEN)),new w(p.length),L,M,L),h(W,u,new w(0),t.Buffer.from(p),L)]}Be.schema=new Map([[Be,{kind:"struct",fields:[["twitterRegistryKey",[32]],["twitterHandle","string"]]}]]);const Pe=new e.PublicKey("85iDfUvr3HJyLM2zcq5BXSiDvUWfw6cSE1FfNBo8Ap29");class Te{constructor(t){this.tag=t.tag,this.nameAccount=new e.PublicKey(t.nameAccount)}static deserialize(e){return s.deserialize(this.schema,Te,e)}static async retrieve(e,t){const r=await e.getAccountInfo(t);if(!r||!r.data)throw new g(exports.ErrorType.FavouriteDomainNotFound);return this.deserialize(r.data)}static async getKey(r,i){return await e.PublicKey.findProgramAddress([t.Buffer.from("favourite_domain"),i.toBuffer()],r)}static getKeySync(r,i){return e.PublicKey.findProgramAddressSync([t.Buffer.from("favourite_domain"),i.toBuffer()],r)}}Te.schema=new Map([[Te,{kind:"struct",fields:[["tag","u8"],["nameAccount",[32]]]}]]);var We;exports.CustomBg=void 0,(We=exports.CustomBg||(exports.CustomBg={})).DegenPoet1="DegenPoet#1",We.Rgb0x001="rgb0x00#1";const De=new e.PublicKey("ART5dr4bDic2sQVZoFheEmUxwQq5VGSx9he7JxHcXNQD"),Ke=new e.PublicKey("CSWvuDHXExVGEMR9kP8xYAHuNjXogeRck9Cnr312CC9g");exports.BONFIDA_FIDA_BNB=O,exports.BONFIDA_USDC_BNB=H,exports.CUSTOM_BG_TLD=q,exports.FavouriteDomain=Te,exports.HASH_PREFIX=D,exports.METAPLEX_ID=X,exports.NAME_OFFERS_ID=Pe,exports.NAME_PROGRAM_ID=W,exports.NameRegistryState=ae,exports.Numberu32=w,exports.Numberu64=b,exports.PYTH_FIDA_PRICE_ACC=C,exports.PYTH_MAPPING_ACC=j,exports.RECORD_V1_SIZE=ye,exports.REFERRERS=F,exports.REGISTER_PROGRAM_ID=N,exports.REVERSE_LOOKUP_CLASS=_,exports.ROOT_DOMAIN_ACCOUNT=K,exports.ReverseTwitterRegistryState=Be,exports.SNSError=g,exports.SOL_RECORD_SIG_LEN=96,exports.TOKENS_SYM_MINT=U,exports.TWITTER_ROOT_PARENT_REGISTRY_KEY=M,exports.TWITTER_VERIFICATION_AUTHORITY=L,exports.USDC_MINT=z,exports.VAULT_OWNER=G,exports.WOLVES_COLLECTION_METADATA=V,exports.burnDomain=(t,r,i)=>{const{pubkey:s}=ee(t),[n]=e.PublicKey.findProgramAddressSync([s.toBuffer()],N),[o]=e.PublicKey.findProgramAddressSync([s.toBuffer(),Uint8Array.from([1,1])],N);return(new E).getInstruction(N,W,e.SystemProgram.programId,s,re(t),o,n,_,r,i)},exports.burnInstruction=E,exports.changeTwitterRegistryData=async function(e,t,r,i){const s=await ue(e),n=await pe(s,void 0,M);return[h(W,n,new w(r),i,t)]},exports.changeVerifiedPubkey=async function(e,t,r,i,s){const n=await ue(t),o=await pe(n,void 0,M);let a=[x(W,o,i,r,void 0)];const c=await ue(r.toString());return await pe(c,L,void 0),a.push(await ve(e,r.toString(),s,L,M)),a=a.concat(await Ie(e,t,o,i,s)),a},exports.check=ie,exports.checkSolRecord=ge,exports.createInstruction=m,exports.createInstructionV3=A,exports.createNameRegistry=Re,exports.createRecordInstruction=ke,exports.createReverseInstruction=v,exports.createReverseName=Ae,exports.createReverseTwitterRegistry=Ie,exports.createSolRecordInstruction=Ee,exports.createSubdomain=async(e,t,r,i=2e3)=>{const s=[],n=t.split(".")[0];if(!n)throw new g(exports.ErrorType.InvalidSubdomain);const{parent:o,pubkey:a}=ee(t),c=await e.getMinimumBalanceForRentExemption(i+ae.HEADER_LEN),u=await Re(e,"\0".concat(n),i,r,r,c,void 0,o);s.push(u);const p=re(t,!0),d=await e.getAccountInfo(p);if(!(null==d?void 0:d.data)){const[,e]=await Ae(a,"\0".concat(n),r,o,r);s.push(...e)}return[[],s]},exports.createV2Instruction=R,exports.createVerifiedTwitterRegistry=async function(t,r,i,s,n){const o=await ue(r),a=await pe(o,void 0,M),c=await t.getMinimumBalanceForRentExemption(s+ae.HEADER_LEN);let u=[m(W,e.SystemProgram.programId,a,i,n,o,new b(c),new w(s),void 0,M,L)];return u=u.concat(await Ie(t,r,a,i,n)),u},exports.createWithNftInstruction=k,exports.deleteInstruction=S,exports.deleteNameRegistry=ve,exports.deleteTwitterRegistry=async function(e,t){const r=await ue(e),i=await pe(r,void 0,M),s=await ue(t.toString()),n=await pe(s,L,M);return[S(W,i,t,t),S(W,n,t,t)]},exports.deserializeRecord=he,exports.findSubdomains=async(e,t)=>{const r=[{memcmp:{offset:0,bytes:t.toBase58()}},{memcmp:{offset:64,bytes:_.toBase58()}}],i=await e.getProgramAccounts(W,{filters:r}),s=await J(e,t),n=i.map((e=>{var t;return null===(t=e.account.data.slice(97).toString("utf-8"))||void 0===t?void 0:t.split("\0").join("")})),o=n.map((e=>ee(e+"."+s).pubkey)),a=await e.getMultipleAccountsInfo(o);return n.filter(((e,t)=>!!a[t]))},exports.getAllDomains=te,exports.getAllRegisteredDomains=async e=>{const t=[{memcmp:{offset:0,bytes:K.toBase58()}}];return await e.getProgramAccounts(W,{dataSlice:{offset:32,length:32},filters:t})},exports.getArtistPubkey=e=>{switch(e){case exports.CustomBg.DegenPoet1:return De;case exports.CustomBg.Rgb0x001:return Ke;default:throw new g(exports.ErrorType.InvalidCustomBg)}},exports.getArweaveRecord=async(e,t)=>await be(e,t,exports.Record.ARWV,!0),exports.getBackgroundRecord=async(e,t)=>await be(e,t,exports.Record.Background,!0),exports.getBackpackRecord=async(e,t)=>await be(e,t,exports.Record.Backpack,!0),exports.getBscRecord=async(e,t)=>await be(e,t,exports.Record.BSC,!0),exports.getBtcRecord=async(e,t)=>await be(e,t,exports.Record.BTC,!0),exports.getCustomBgKeys=(e,t)=>{const r=Y(t),i=Y(e),s=Z(i,void 0,q);return{domainKey:s,bgKey:Z(r,void 0,s)}},exports.getDiscordRecord=async(e,t)=>await be(e,t,exports.Record.Discord,!0),exports.getDogeRecord=async(e,t)=>await be(e,t,exports.Record.DOGE,!0),exports.getDomainKey=le,exports.getDomainKeySync=ee,exports.getDomainKeysWithReverses=async function(e,t){const r=await te(e,t),i=await Q(e,r);return r.map(((e,t)=>({pubKey:e,domain:i[t]})))},exports.getEmailRecord=async(e,t)=>await be(e,t,exports.Record.Email,!0),exports.getEthRecord=async(e,t)=>await be(e,t,exports.Record.ETH,!0),exports.getFavoriteDomain=async(t,r)=>{const[i]=Te.getKeySync(Pe,new e.PublicKey(r)),s=await Te.retrieve(t,i),n=await J(t,s.nameAccount);return{domain:s.nameAccount,reverse:n}},exports.getGithubRecord=async(e,t)=>await be(e,t,exports.Record.Github,!0),exports.getHandleAndRegistryKey=async function(t,r){const i=await ue(r.toString()),s=await pe(i,L,M);let n=await Be.retrieve(t,s);return[n.twitterHandle,new e.PublicKey(n.twitterRegistryKey)]},exports.getHashedName=ue,exports.getHashedNameSync=Y,exports.getInjectiveRecord=async(e,t)=>await be(e,t,exports.Record.Injective,!0),exports.getIpfsRecord=async(e,t)=>await be(e,t,exports.Record.IPFS,!0),exports.getLtcRecord=async(e,t)=>await be(e,t,exports.Record.LTC,!0),exports.getNameAccountKey=pe,exports.getNameAccountKeySync=Z,exports.getNameOwner=ce,exports.getPicRecord=async(e,t)=>await be(e,t,exports.Record.Pic,!0),exports.getPointRecord=async(e,t)=>await be(e,t,exports.Record.POINT,!0),exports.getRecord=be,exports.getRecordKeySync=we,exports.getRecords=async function(e,t,r,i){const s=r.map((e=>we(t,e))),n=await ae.retrieveBatch(e,s);return i?n.map(((e,i)=>{if(e)return he(e,r[i],we(t,r[i]))})):n},exports.getRedditRecord=async(e,t)=>await be(e,t,exports.Record.Reddit,!0),exports.getReverseKey=async(e,t)=>{const{pubkey:r,parent:i}=await le(e),s=await ue(r.toBase58());return await pe(s,_,t?i:void 0)},exports.getReverseKeySync=re,exports.getShdwRecord=async(e,t)=>await be(e,t,exports.Record.SHDW,!0),exports.getSolRecord=me,exports.getTelegramRecord=async(e,t)=>await be(e,t,exports.Record.Telegram,!0),exports.getTokenizedDomains=async(e,t)=>{const i=await(async(e,t)=>{const i=[...ne(t.toBase58()),{dataSize:165}],s=(await e.getProgramAccounts(r.TOKEN_PROGRAM_ID,{filters:i})).map((e=>r.AccountLayout.decode(e.account.data))).map((t=>oe(e,t)));return(await Promise.all(s)).filter((e=>void 0!==e))})(e,t);return(await Q(e,i.map((e=>e.nameAccount)))).map(((e,t)=>({key:i[t].nameAccount,mint:i[t].nftMint,reverse:e}))).filter((e=>!!e.reverse))},exports.getTwitterHandleandRegistryKeyViaFilters=async function(t,r){const i=[{memcmp:{offset:0,bytes:M.toBase58()}},{memcmp:{offset:32,bytes:r.toBase58()}},{memcmp:{offset:64,bytes:L.toBase58()}}],n=await t.getProgramAccounts(W,{filters:i});for(const t of n)if(t.account.data.length>ae.HEADER_LEN+32){let r=t.account.data.slice(ae.HEADER_LEN),i=s.deserializeUnchecked(Be.schema,Be,r);return[i.twitterHandle,new e.PublicKey(i.twitterRegistryKey)]}throw new g(exports.ErrorType.AccountDoesNotExist)},exports.getTwitterRecord=async(e,t)=>await be(e,t,exports.Record.Twitter,!0),exports.getTwitterRegistry=async function(e,t){const r=await ue(t),i=await pe(r,void 0,M),{registry:s}=await ae.retrieve(e,i);return s},exports.getTwitterRegistryData=async function(r,i){const s=[{memcmp:{offset:0,bytes:M.toBase58()}},{memcmp:{offset:32,bytes:i.toBase58()}},{memcmp:{offset:64,bytes:new e.PublicKey(t.Buffer.alloc(32,0)).toBase58()}}],n=await r.getProgramAccounts(W,{filters:s});if(n.length>1)throw new g(exports.ErrorType.MultipleRegistries);return n[0].account.data.slice(ae.HEADER_LEN)},exports.getTwitterRegistryKey=async function(e){const t=await ue(e);return await pe(t,void 0,M)},exports.getUrlRecord=async(e,t)=>await be(e,t,exports.Record.Url,!0),exports.performReverseLookup=async function(e,t){const r=await ue(t.toBase58()),s=await pe(r,_),{registry:n}=await ae.retrieve(e,s);if(!n.data)throw new g(exports.ErrorType.NoAccountData);const o=new i(n.data.slice(0,4),"le").toNumber();return n.data.slice(4,4+o).toString()},exports.performReverseLookupBatch=async function(e,t){let r=[];for(let e of t){const t=await ue(e.toBase58()),i=await pe(t,_);r.push(i)}return(await ae.retrieveBatch(e,r)).map((e=>{if(void 0===e||void 0===e.data)return;let t=new i(e.data.slice(0,4),"le").toNumber();return e.data.slice(4,4+t).toString()}))},exports.reallocInstruction=function(r,i,s,n,o,a){const c=[t.Buffer.from(Int8Array.from([4])),a.toBuffer()],u=t.Buffer.concat(c),p=[{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1}];return new e.TransactionInstruction({keys:p,programId:r,data:u})},exports.registerDomainName=async(t,i,s,n,a,c=z,u)=>{if(i.includes(".")||i.trim().toLowerCase()!==i)throw new g(exports.ErrorType.InvalidDomain);const[p]=e.PublicKey.findProgramAddressSync([N.toBuffer()],N),d=Y(i),l=Z(d,void 0,K),f=Y(l.toBase58()),y=Z(f,p),[w]=e.PublicKey.findProgramAddressSync([l.toBuffer()],N),b=F.findIndex((e=>null==u?void 0:u.equals(e)));let m;const h=[];if(-1!==b&&u){m=r.getAssociatedTokenAddressSync(c,u,!0);const e=await t.getAccountInfo(m);if(!(null==e?void 0:e.data)){const e=r.createAssociatedTokenAccountInstruction(n,m,u,c);h.push(e)}}const x=new o.PythHttpClient(t,o.getPythProgramKeyForCluster("mainnet-beta")),S=await x.getData(),R=U.get(c.toBase58());if(!R)throw new g(exports.ErrorType.SymbolNotFound,`No symbol found for mint ${c.toBase58()}`);const v=S.productPrice.get("Crypto."+R+"/USD"),k=S.productFromSymbol.get("Crypto."+R+"/USD"),E=r.getAssociatedTokenAddressSync(c,G),B=new A({name:i,space:s,referrerIdxOpt:-1!=b?b:null}).getInstruction(N,W,K,l,y,e.SystemProgram.programId,p,n,a,j,v.productAccountKey,new e.PublicKey(k.price_account),E,r.TOKEN_PROGRAM_ID,e.SYSVAR_RENT_PUBKEY,w,m);return h.push(B),[[],h]},exports.registerWithNft=(t,i,s,n,o,a,c,u,p)=>{const[d]=e.PublicKey.findProgramAddressSync([s.toBuffer()],N);return new k({space:i,name:t}).getInstruction(N,W,K,s,n,e.SystemProgram.programId,_,o,a,c,u,p,V,r.TOKEN_PROGRAM_ID,e.SYSVAR_RENT_PUBKEY,d,X)},exports.resolve=async(r,i)=>{const{pubkey:s}=ee(i),{registry:n,nftOwner:o}=await ae.retrieve(r,s);if(o)return o;try{const s=we(i,exports.Record.SOL),o=await me(r,i);if(!(null==o?void 0:o.data))throw new g(exports.ErrorType.NoRecordData);const a=new TextEncoder,c=t.Buffer.concat([o.data.slice(0,32),s.toBuffer()]),u=a.encode(c.toString("hex"));if(!ge(u,o.data.slice(32),n.owner))throw new g(exports.ErrorType.InvalidSignature);return new e.PublicKey(o.data.slice(0,32))}catch(e){if(e instanceof Error&&"FetchError"===e.name)throw e}return n.owner},exports.retrieveNftOwner=se,exports.retrieveNfts=async t=>{const r=await t.getProgramAccounts(B,{filters:[{memcmp:{offset:0,bytes:"3"}}]});return r.map((t=>new e.PublicKey(t.account.data.slice(66,98))))},exports.reverseLookup=J,exports.reverseLookupBatch=Q,exports.serializeRecord=xe,exports.serializeSolRecord=Se,exports.transferInstruction=x,exports.transferNameOwnership=async function(e,t,r,i,s,n){const o=await ue(t),a=await pe(o,i,s);let c;return c=i||(await ae.retrieve(e,a)).registry.owner,x(W,a,r,c,i,s,n)},exports.transferSubdomain=async(e,t,r,i,s)=>{const{pubkey:n,isSub:o,parent:a}=ee(t);if(!a||!o)throw new g(exports.ErrorType.InvalidSubdomain);if(!s){const{registry:t}=await ae.retrieve(e,n);s=t.owner}let c,u;i&&(c=a,u=(await ae.retrieve(e,a)).registry.owner);return x(W,n,r,s,void 0,c,u)},exports.updateInstruction=h,exports.updateNameRegistryData=async function(e,t,r,i,s,n){const o=await ue(t),a=await pe(o,s,n);let c;return c=s||(await ae.retrieve(e,a)).registry.owner,h(W,a,new w(r),i,c)},exports.updateRecordInstruction=async(e,t,r,i,s,n)=>{ie(r!==exports.Record.SOL,exports.ErrorType.UnsupportedRecord);const{pubkey:o}=ee(`${r}.${t}`,!0),a=await e.getAccountInfo(o);ie(!!(null==a?void 0:a.data),exports.ErrorType.AccountDoesNotExist);const c=xe(i,r);if((null==a?void 0:a.data.slice(96).length)!==c.length)return[S(W,o,n,s),await ke(e,t,r,i,s,n)];return[h(W,o,new w(0),c,s)]},exports.updateSolRecordInstruction=async(e,t,r,i,s,n)=>{const{pubkey:o}=ee(`${exports.Record.SOL}.${t}`,!0),a=await e.getAccountInfo(o);if(ie(!!(null==a?void 0:a.data),exports.ErrorType.AccountDoesNotExist),96!==(null==a?void 0:a.data.length))return[S(W,o,n,i),await Ee(e,t,r,i,s,n)];const c=Se(r,o,i,s);return[h(W,o,new w(0),c,i)]};

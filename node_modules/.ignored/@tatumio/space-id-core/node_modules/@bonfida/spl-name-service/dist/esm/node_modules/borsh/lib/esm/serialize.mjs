import{integers as e}from"./types.mjs";import{EncodeBuffer as t}from"./buffer.mjs";import{expect_type as n,expect_bigint as o,expect_enum as r,isArrayLike as i,expect_same_size as s}from"./utils.mjs";var c=function(){function c(e){this.encoded=new t,this.fieldPath=["value"],this.checkTypes=e}return c.prototype.encode=function(e,t){return this.encode_value(e,t),this.encoded.get_used_buffer()},c.prototype.encode_value=function(t,n){if("string"==typeof n){if(e.includes(n))return this.encode_integer(t,n);if("string"===n)return this.encode_string(t);if("bool"===n)return this.encode_boolean(t)}if("object"==typeof n){if("option"in n)return this.encode_option(t,n);if("enum"in n)return this.encode_enum(t,n);if("array"in n)return this.encode_array(t,n);if("set"in n)return this.encode_set(t,n);if("map"in n)return this.encode_map(t,n);if("struct"in n)return this.encode_struct(t,n)}},c.prototype.encode_integer=function(e,t){var r=parseInt(t.substring(1));r<=32||"f64"==t?(this.checkTypes&&n(e,"number",this.fieldPath),this.encoded.store_value(e,t)):(this.checkTypes&&o(e,this.fieldPath),this.encode_bigint(BigInt(e),r))},c.prototype.encode_bigint=function(e,t){for(var n=t/8,o=new Uint8Array(n),r=0;r<n;r++)o[r]=Number(e&BigInt(255)),e>>=BigInt(8);this.encoded.store_bytes(new Uint8Array(o))},c.prototype.encode_string=function(e){this.checkTypes&&n(e,"string",this.fieldPath);for(var t=e,o=[],r=0;r<t.length;r++){var i=t.charCodeAt(r);i<128?o.push(i):i<2048?o.push(192|i>>6,128|63&i):i<55296||i>=57344?o.push(224|i>>12,128|i>>6&63,128|63&i):(r++,i=65536+((1023&i)<<10|1023&t.charCodeAt(r)),o.push(240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i))}this.encoded.store_value(o.length,"u32"),this.encoded.store_bytes(new Uint8Array(o))},c.prototype.encode_boolean=function(e){this.checkTypes&&n(e,"boolean",this.fieldPath),this.encoded.store_value(e?1:0,"u8")},c.prototype.encode_option=function(e,t){null==e?this.encoded.store_value(0,"u8"):(this.encoded.store_value(1,"u8"),this.encode_value(e,t.option))},c.prototype.encode_enum=function(e,t){this.checkTypes&&r(e,this.fieldPath);for(var n=Object.keys(e)[0],o=0;o<t.enum.length;o++){var i=t.enum[o];if(n===Object.keys(i.struct)[0])return this.encoded.store_value(o,"u8"),this.encode_struct(e,i)}throw new Error("Enum key (".concat(n,") not found in enum schema: ").concat(JSON.stringify(t)," at ").concat(this.fieldPath.join(".")))},c.prototype.encode_array=function(e,t){if(i(e))return this.encode_arraylike(e,t);if(e instanceof ArrayBuffer)return this.encode_buffer(e,t);throw new Error("Expected Array-like not ".concat(typeof e,"(").concat(e,") at ").concat(this.fieldPath.join(".")))},c.prototype.encode_arraylike=function(e,t){t.array.len?s(e.length,t.array.len,this.fieldPath):this.encoded.store_value(e.length,"u32");for(var n=0;n<e.length;n++)this.encode_value(e[n],t.array.type)},c.prototype.encode_buffer=function(e,t){t.array.len?s(e.byteLength,t.array.len,this.fieldPath):this.encoded.store_value(e.byteLength,"u32"),this.encoded.store_bytes(new Uint8Array(e))},c.prototype.encode_set=function(e,t){this.checkTypes&&n(e,"object",this.fieldPath);var o=e instanceof Set?Array.from(e.values()):Object.values(e);this.encoded.store_value(o.length,"u32");for(var r=0,i=o;r<i.length;r++){var s=i[r];this.encode_value(s,t.set)}},c.prototype.encode_map=function(e,t){this.checkTypes&&n(e,"object",this.fieldPath);var o=e instanceof Map,r=o?Array.from(e.keys()):Object.keys(e);this.encoded.store_value(r.length,"u32");for(var i=0,s=r;i<s.length;i++){var c=s[i];this.encode_value(c,t.map.key),this.encode_value(o?e.get(c):e[c],t.map.value)}},c.prototype.encode_struct=function(e,t){this.checkTypes&&n(e,"object",this.fieldPath);for(var o=0,r=Object.keys(t.struct);o<r.length;o++){var i=r[o];this.fieldPath.push(i),this.encode_value(e[i],t.struct[i]),this.fieldPath.pop()}},c}();export{c as BorshSerializer};
//# sourceMappingURL=serialize.mjs.map
